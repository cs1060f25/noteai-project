#!/bin/bash

# pre-commit hook: run linting and formatting checks for both frontend and backend

set -e

# colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # no color

# track if any checks failed
FAILED=0

echo ""
echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BOLD}${CYAN}🔍  PRE-COMMIT QUALITY CHECKS${NC}"
echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# ================== FRONTEND CHECKS ==================
if [ -d "frontend" ]; then
    echo -e "${BOLD}${BLUE}📦 FRONTEND${NC}"
    echo -e "${BLUE}────────────────────────────────────────${NC}"
    cd frontend

    # check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo -e "${YELLOW}⚠️  Skipped (node_modules not found)${NC}"
        echo ""
    else
        # auto-format with prettier
        echo -e "  ${CYAN}✨ Formatting with Prettier...${NC}"
        if npm run format > /dev/null 2>&1; then
            echo -e "  ${GREEN}✓ Code formatted${NC}"
        else
            echo -e "  ${RED}✗ Formatting failed${NC}"
            FAILED=1
        fi

        # run linting
        echo -e "  ${CYAN}🔎 Linting with ESLint...${NC}"
        LINT_OUTPUT=$(npm run lint 2>&1)
        LINT_EXIT_CODE=$?

        # check for errors (exit code != 0 means errors, warnings are ok)
        if [ $LINT_EXIT_CODE -ne 0 ]; then
            echo -e "  ${RED}✗ Linting failed (errors found)${NC}"
            echo "$LINT_OUTPUT"
            FAILED=1
        elif echo "$LINT_OUTPUT" | grep -q "warning"; then
            # warnings present but no errors
            WARN_COUNT=$(echo "$LINT_OUTPUT" | grep -c "warning" || true)
            echo -e "  ${YELLOW}⚠ Linting passed (${WARN_COUNT} warnings)${NC}"
        else
            echo -e "  ${GREEN}✓ Linting passed${NC}"
        fi

        # run type checking
        echo -e "  ${CYAN}🔧 Type checking with TypeScript...${NC}"
        if npm run type-check > /dev/null 2>&1; then
            echo -e "  ${GREEN}✓ Types valid${NC}"
        else
            echo -e "  ${RED}✗ Type errors found${NC}"
            FAILED=1
        fi

        echo ""
    fi

    cd ..
fi

# ================== BACKEND CHECKS ==================
if [ -d "backend" ]; then
    echo -e "${BOLD}${BLUE}🐍 BACKEND${NC}"
    echo -e "${BLUE}────────────────────────────────────────${NC}"
    cd backend

    # check if virtual environment or uv is available
    if [ ! -d ".venv" ] && ! command -v uv &> /dev/null; then
        echo -e "${YELLOW}⚠️  Skipped (no .venv or uv found)${NC}"
        echo ""
    else
        # run linting
        echo -e "  ${CYAN}🔎 Linting with Ruff...${NC}"
        if [ -f "scripts/lint.sh" ] && ./scripts/lint.sh > /dev/null 2>&1; then
            echo -e "  ${GREEN}✓ Linting passed${NC}"
        else
            echo -e "  ${RED}✗ Linting failed${NC}"
            FAILED=1
        fi

        # run formatting
        echo -e "  ${CYAN}✨ Formatting with Black...${NC}"
        if [ -f "scripts/format.sh" ] && ./scripts/format.sh > /dev/null 2>&1; then
            echo -e "  ${GREEN}✓ Code formatted${NC}"
        else
            echo -e "  ${YELLOW}⚠ Formatting skipped${NC}"
        fi

        echo ""
    fi

    cd ..
fi

# ================== FINAL RESULT ==================
echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
if [ $FAILED -eq 1 ]; then
    echo -e "${BOLD}${RED}❌ CHECKS FAILED${NC}"
    echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}💡 Tip: Fix the issues above and try again${NC}"
    echo -e "${YELLOW}   To skip (not recommended): git commit --no-verify${NC}"
    echo ""
    exit 1
else
    echo -e "${BOLD}${GREEN}✅ ALL CHECKS PASSED${NC}"
    echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
fi

exit 0
